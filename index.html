<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Academy Attendance Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 14px; }
    h2 { text-align:center; margin-bottom:8px; }
    .controls { margin-bottom:10px; text-align:center; }
    table { border-collapse: collapse; width: 100%; min-width: 900px; }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 6px;
      text-align: center;
      vertical-align: middle;
      white-space: nowrap;
    }
    th { background:#f2f2f2; position: sticky; top: 0; z-index: 4; }

    /* Sticky/fixed first columns */
    /* Student Name column only */
    th:nth-child(2), td:nth-child(2) {
      width: 180px; 
      max-width: 180px;
      position: sticky; 
      left: 0;
      background: #f9f9f9; 
      z-index: 5;
      text-align: left; 
      padding-left: 8px;
    }

    .delete-btn { color: red; cursor: pointer; font-weight: bold; }
    .add-row td { cursor: pointer; background:#e8f5e9; color:#2e7d32; font-weight:700; text-align:center; }
    td.att-present { color: #0b7a1f; font-weight:700; } /* green tick */
    td.att-absent { color: #b30f0f; font-weight:700; }   /* red cross */
    select.fee-select { width: 100%; min-width: 60px; }
    .note { font-size:12px; color:#555; margin-top:6px; }
    .table-wrap { overflow-x:auto; }
  </style>
</head>
<body>
  <h2>Academy Attendance Tracker</h2>

  <div class="controls">
    Month:
    <select id="monthSelect"></select>
    <button onclick="saveMonth()">üíæ Save Month</button>
    <button onclick="deleteMonth()">üóë Delete Month</button>
  </div>

  <div class="table-wrap">
    <table id="attendanceTable">
      <thead id="thead">
        <tr id="headerRow">
          <th>#</th>
          <th>Student Name</th>
          <th>‚ùå</th>
          <th>Fee Pay</th>
          <!-- day headers appended dynamically -->
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="note">Click a day cell to toggle: (blank ‚Üí ‚úî ‚Üí ‚úñ ‚Üí blank). Sundays are highlighted; attendance not required. Click student name to edit. Click ‚ùå to remove student.</div>

<script>
(() => {
  const monthSelect = document.getElementById('monthSelect');
  const headerRow = document.getElementById('headerRow');
  const tbody = document.getElementById('tbody');

  const now = new Date();
  const thisYear = now.getFullYear();
  for (let y = thisYear - 1; y <= thisYear + 1; y++) {
    for (let m = 0; m < 12; m++) {
      const val = `${y}-${String(m+1).padStart(2,'0')}`;
      const text = new Date(y, m, 1).toLocaleString('default', { month: 'long', year: 'numeric' });
      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = text;
      monthSelect.appendChild(opt);
    }
  }
  const currentKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  monthSelect.value = currentKey;

  function parseKey(key) {
    const [y, mm] = key.split('-').map(Number);
    return { year: y, monthIndex: mm - 1 };
  }
  function daysInMonth(year, monthIndex) {
    return new Date(year, monthIndex + 1, 0).getDate();
  }
  function findPreviousSavedMonth(year, monthIndex) {
    let y = year, m = monthIndex - 1;
    for (let steps = 0; steps < 36; steps++) {
      if (m < 0) { y -= 1; m = 11; }
      const key = `${y}-${String(m+1).padStart(2,'0')}`;
      if (localStorage.getItem('attendance_' + key)) return key;
      m -= 1;
    }
    return null;
  }

  function buildHeader(year, monthIndex) {
    while (headerRow.cells.length > 4) headerRow.deleteCell(4);
    const days = daysInMonth(year, monthIndex);
    for (let d = 1; d <= days; d++) {
      const th = document.createElement('th');
      th.textContent = d;
      const dayDate = new Date(year, monthIndex, d);
      if (dayDate.getDay() === 0) { // Sunday
        th.style.background = '#f0e68c';
      }
      if (year === now.getFullYear() && monthIndex === now.getMonth() && d === now.getDate()) {
        th.style.background = '#fff8b3';
      }
      headerRow.appendChild(th);
    }
  }

  function loadMonth() {
    tbody.innerHTML = '';
    const key = monthSelect.value;
    const { year, monthIndex } = parseKey(key);
    buildHeader(year, monthIndex);

    let rows = localStorage.getItem('attendance_' + key);
    rows = rows ? JSON.parse(rows) : null;
    if (!rows) {
      const prevKey = findPreviousSavedMonth(year, monthIndex);
      if (prevKey) {
        const prevData = JSON.parse(localStorage.getItem('attendance_' + prevKey));
        rows = prevData.map(r => ({ name: r.name || '', fee: '', attendance: [] }));
      } else {
        rows = [];
      }
    }

    rows.forEach((r, idx) => appendRow(idx + 1, r.name, r.fee, r.attendance, year, monthIndex));

    const addTr = document.createElement('tr');
    addTr.className = 'add-row';
    const td = document.createElement('td');
    td.colSpan = 4 + daysInMonth(year, monthIndex);
    td.textContent = '‚ûï Add Student';
    td.onclick = () => {
      const newIndex = tbody.rows.length + 1;
      appendRow(newIndex, '', '', [], year, monthIndex);
      saveMonth();
    };
    addTr.appendChild(td);
    tbody.appendChild(addTr);
  }

  function appendRow(roll, name, fee, attendanceArr, year, monthIndex) {
    const tr = document.createElement('tr');

    const tdRoll = document.createElement('td'); tdRoll.textContent = roll; tr.appendChild(tdRoll);

    const tdName = document.createElement('td');
    tdName.contentEditable = true; tdName.spellcheck = false; tdName.textContent = name || '';
    tdName.onblur = () => saveMonth();
    tr.appendChild(tdName);

    const tdDel = document.createElement('td');
    const delSpan = document.createElement('span'); delSpan.className='delete-btn'; delSpan.textContent='‚úñ';
    delSpan.title='Delete student';
    delSpan.onclick = (ev) => { ev.stopPropagation(); if (!confirm('Delete this student?')) return; tr.remove(); renumber(); saveMonth(); };
    tdDel.appendChild(delSpan); tr.appendChild(tdDel);

    const tdFee = document.createElement('td');
    const sel = document.createElement('select'); sel.className='fee-select';
    ['', 'Yes', 'No'].forEach(v => { const o = document.createElement('option'); o.value=v; o.textContent=v; if(v===fee)o.selected=true; sel.appendChild(o); });
    sel.onchange = () => saveMonth();
    tdFee.appendChild(sel); tr.appendChild(tdFee);

    const days = daysInMonth(year, monthIndex);
    for(let d=1; d<=days; d++){
      const td = document.createElement('td');
      const val = attendanceArr && attendanceArr[d-1] ? attendanceArr[d-1] : '';
      td.textContent = val;
      updateAttClass(td);

      const dayDate = new Date(year, monthIndex, d);
      if(dayDate.getDay() === 0){ // Sunday
        td.style.background = '#f0e68c';
        td.title = 'Sunday - No attendance required';
      } else {
        td.onclick = () => { 
          if(td.textContent==='') td.textContent='‚úî';
          else if(td.textContent==='‚úî') td.textContent='‚úñ';
          else td.textContent='';
          updateAttClass(td);
          saveMonth();
        };
      }

      tr.appendChild(td);
    }

    const addRow = tbody.querySelector('tr.add-row');
    if(addRow) tbody.insertBefore(tr, addRow);
    else tbody.appendChild(tr);
  }

  function updateAttClass(td){ td.classList.remove('att-present','att-absent'); if(td.textContent==='‚úî') td.classList.add('att-present'); if(td.textContent==='‚úñ') td.classList.add('att-absent'); }
  function renumber(){ let r=1; [...tbody.rows].forEach(row=>{ if(row.classList.contains('add-row')) return; const c0=row.cells[0]; if(c0)c0.textContent=r++; }); }

  function saveMonth(){
    const key = monthSelect.value;
    const rows=[];
    [...tbody.rows].forEach(row=>{
      if(row.classList.contains('add-row')) return;
      const cells=row.cells;
      const name=cells[1].innerText.trim();
      const fee=(cells[3].querySelector('select')||{}).value||'';
      const attendance=[];
      for(let i=4;i<cells.length;i++) attendance.push(cells[i].innerText);
      rows.push({name,fee,attendance});
    });
    localStorage.setItem('attendance_'+key,JSON.stringify(rows));
  }

  function deleteMonth(){
    const key = monthSelect.value;
    if(!confirm('Delete all data for selected month?')) return;
    localStorage.removeItem('attendance_'+key);
    loadMonth();
  }

  monthSelect.addEventListener('change', loadMonth);
  window.saveMonth = saveMonth;
  window.deleteMonth = deleteMonth;

  loadMonth();

})();
</script>
</body>
</html>
